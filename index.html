<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SELFIES-JS Playground</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        header {
            background: #2d2d30;
            padding: 1rem 2rem;
            border-bottom: 1px solid #3e3e42;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        h1 {
            font-size: 1.5rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo {
            width: 32px;
            height: 32px;
        }

        .subtitle {
            font-size: 0.9rem;
            color: #858585;
            margin-top: 0.25rem;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: #2d2d30;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #3e3e42;
            font-weight: 600;
            font-size: 0.9rem;
            color: #cccccc;
        }

        .editor-panel {
            border-right: 1px solid #3e3e42;
        }

        #editor {
            flex: 1;
            overflow: auto;
        }

        .CodeMirror {
            height: 100%;
            font-size: 14px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .output-panel {
            display: flex;
            flex-direction: column;
        }

        .output-content {
            flex: 1;
            overflow: auto;
            padding: 1.5rem;
        }

        .output-section {
            background: #252526;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .output-section h3 {
            color: #4ec9b0;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .output-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #3e3e42;
        }

        .output-row:last-child {
            border-bottom: none;
        }

        .output-label {
            color: #9cdcfe;
            font-weight: 500;
        }

        .output-value {
            color: #ce9178;
            font-family: 'Consolas', monospace;
        }

        .molecule-viewer {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 250px;
        }

        .molecule-viewer canvas {
            max-width: 100%;
            height: auto;
        }

        .error {
            background: #5a1d1d;
            border-color: #be1100;
            color: #f48771;
        }

        .error h3 {
            color: #f48771;
        }

        .toolbar {
            background: #2d2d30;
            padding: 0.5rem 1rem;
            border-top: 1px solid #3e3e42;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }

        button:hover {
            background: #1177bb;
        }

        button:active {
            background: #0d5a8f;
        }

        .status {
            margin-left: auto;
            font-size: 0.85rem;
            color: #858585;
        }

        .status.success {
            color: #4ec9b0;
        }

        .status.error {
            color: #f48771;
        }

        pre {
            background: #1e1e1e;
            padding: 0.5rem;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 0.85rem;
        }

        .test-results {
            max-height: 200px;
            overflow-y: auto;
        }

        .test-item {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .test-item.pass {
            background: #1e3a1e;
            color: #4ec9b0;
        }

        .test-item.fail {
            background: #5a1d1d;
            color: #f48771;
        }

        a {
            color: #3794ff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .editor-panel {
                border-right: none;
                border-bottom: 1px solid #3e3e42;
                max-height: 40vh;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>
            <svg class="logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="20" r="8" fill="#4ec9b0"/>
                <circle cx="30" cy="50" r="8" fill="#569cd6"/>
                <circle cx="70" cy="50" r="8" fill="#ce9178"/>
                <circle cx="50" cy="80" r="8" fill="#dcdcaa"/>
                <line x1="50" y1="20" x2="30" y2="50" stroke="#858585" stroke-width="2"/>
                <line x1="50" y1="20" x2="70" y2="50" stroke="#858585" stroke-width="2"/>
                <line x1="30" y1="50" x2="50" y2="80" stroke="#858585" stroke-width="2"/>
                <line x1="70" y1="50" x2="50" y2="80" stroke="#858585" stroke-width="2"/>
            </svg>
            SELFIES-JS Playground
        </h1>
        <p class="subtitle">A 100% robust molecular string representation for JavaScript</p>
    </header>

    <div class="container">
        <div class="panel editor-panel">
            <div class="panel-header">SELFIES Editor</div>
            <div id="editor"></div>
            <div class="toolbar">
                <button id="runBtn">Run Tests</button>
                <button id="clearBtn">Clear</button>
                <button id="exampleBtn">Load Example</button>
                <span class="status" id="status">Ready</span>
            </div>
        </div>

        <div class="panel output-panel">
            <div class="panel-header">Output</div>
            <div class="output-content" id="output">
                <div class="output-section">
                    <h3>Welcome</h3>
                    <p>Type a SELFIES string in the editor (e.g., <code>[C][C][O]</code>) to see it decoded to SMILES.</p>
                    <p style="margin-top: 0.5rem;">Or try encoding SMILES to SELFIES!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>

    <!-- Load RDKit.js -->
    <script src="https://unpkg.com/@rdkit/rdkit/dist/RDKit_minimal.js"></script>

    <!-- Load SELFIES-JS from gh-pages (absolute path) -->
    <script src="https://ghost---shadow.github.io/selfies-js/dist/selfies.umd.min.js"></script>

    <script>
        // Initialize RDKit
        let RDKitModule;
        initRDKitModule().then(function(instance) {
            RDKitModule = instance;
            console.log('RDKit version: ' + RDKitModule.version());
            // Process initial content after RDKit is loaded
            processInput();
        });

        // Initialize CodeMirror
        const editor = CodeMirror(document.getElementById('editor'), {
            value: '[C][C][O]\n[C][=C]\n[C][#N]\nCCO\nc1ccccc1',
            mode: 'javascript',
            theme: 'monokai',
            lineNumbers: true,
            lineWrapping: true,
            autofocus: true
        });

        const output = document.getElementById('output');
        const status = document.getElementById('status');

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Draw molecule using RDKit
        function drawMolecule(smiles, canvasId) {
            if (!RDKitModule) {
                return '<p style="color: #858585;">Loading RDKit...</p>';
            }

            try {
                const mol = RDKitModule.get_mol(smiles);
                if (!mol || !mol.is_valid()) {
                    return '<p style="color: #f48771;">Invalid molecule structure</p>';
                }

                // Create canvas element with unique ID
                const canvas = document.createElement('canvas');
                canvas.id = canvasId;
                canvas.width = 300;
                canvas.height = 250;

                // Draw molecule to canvas
                mol.draw_to_canvas(canvas, -1, -1);
                mol.delete();

                return canvas.outerHTML;
            } catch (error) {
                console.error('RDKit drawing error:', error);
                return '<p style="color: #f48771;">Error rendering structure</p>';
            }
        }

        // Process SELFIES/SMILES input
        function processInput() {
            const lines = editor.getValue().split('\n');
            let html = '';
            let hasError = false;
            let moleculeIndex = 0;

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;

                try {
                    // Check if it's SELFIES (contains brackets) or SMILES
                    if (trimmed.includes('[') && trimmed.includes(']')) {
                        // Try to decode as SELFIES
                        const decoded = SELFIES.decode(trimmed);
                        const isValid = SELFIES.isValid(trimmed);
                        const mw = SELFIES.getMolecularWeight(trimmed);
                        const formula = SELFIES.getFormula(trimmed);

                        const canvasId = `molecule-canvas-${moleculeIndex++}`;
                        const moleculeViewer = drawMolecule(decoded, canvasId);

                        html += `
                            <div class="output-section">
                                <h3>SELFIES → SMILES</h3>
                                <div class="output-row">
                                    <span class="output-label">Input:</span>
                                    <span class="output-value">${trimmed}</span>
                                </div>
                                <div class="output-row">
                                    <span class="output-label">Output:</span>
                                    <span class="output-value">${decoded}</span>
                                </div>
                                <div class="output-row">
                                    <span class="output-label">Valid:</span>
                                    <span class="output-value">${isValid ? '✓' : '✗'}</span>
                                </div>
                                <div class="output-row">
                                    <span class="output-label">Formula:</span>
                                    <span class="output-value">${formula}</span>
                                </div>
                                <div class="output-row">
                                    <span class="output-label">Molecular Weight:</span>
                                    <span class="output-value">${mw.toFixed(2)} g/mol</span>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <h4 style="color: #4ec9b0; font-size: 0.85rem; margin-bottom: 0.5rem;">2D STRUCTURE</h4>
                                    <div class="molecule-viewer">${moleculeViewer}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        // Try to encode as SMILES
                        const encoded = SELFIES.encode(trimmed);
                        const mw = SELFIES.getMolecularWeight(encoded);
                        const formula = SELFIES.getFormula(encoded);

                        const canvasId = `molecule-canvas-${moleculeIndex++}`;
                        const moleculeViewer = drawMolecule(trimmed, canvasId);

                        html += `
                            <div class="output-section">
                                <h3>SMILES → SELFIES</h3>
                                <div class="output-row">
                                    <span class="output-label">Input:</span>
                                    <span class="output-value">${trimmed}</span>
                                </div>
                                <div class="output-row">
                                    <span class="output-label">Output:</span>
                                    <span class="output-value">${encoded}</span>
                                </div>
                                <div class="output-row">
                                    <span class="output-label">Formula:</span>
                                    <span class="output-value">${formula}</span>
                                </div>
                                <div class="output-row">
                                    <span class="output-label">Molecular Weight:</span>
                                    <span class="output-value">${mw.toFixed(2)} g/mol</span>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <h4 style="color: #4ec9b0; font-size: 0.85rem; margin-bottom: 0.5rem;">2D STRUCTURE</h4>
                                    <div class="molecule-viewer">${moleculeViewer}</div>
                                </div>
                            </div>
                        `;
                    }
                } catch (error) {
                    hasError = true;
                    html += `
                        <div class="output-section error">
                            <h3>Error</h3>
                            <div class="output-row">
                                <span class="output-label">Input:</span>
                                <span class="output-value">${trimmed}</span>
                            </div>
                            <div class="output-row">
                                <span class="output-label">Message:</span>
                                <span class="output-value">${error.message}</span>
                            </div>
                        </div>
                    `;
                }
            }

            if (html === '') {
                html = `
                    <div class="output-section">
                        <h3>Welcome</h3>
                        <p>Type a SELFIES string in the editor (e.g., <code>[C][C][O]</code>) to see it decoded to SMILES.</p>
                        <p style="margin-top: 0.5rem;">Or try encoding SMILES to SELFIES!</p>
                        <p style="margin-top: 0.5rem; color: #4ec9b0;">New: View 2D molecular structures with RDKit!</p>
                    </div>
                `;
            }

            output.innerHTML = html;
            status.textContent = hasError ? 'Error in input' : 'Ready';
            status.className = `status ${hasError ? 'error' : 'success'}`;
        }

        // Run comprehensive tests
        async function runTests() {
            status.textContent = 'Running tests...';
            status.className = 'status';

            const tests = [
                // Basic decoding
                { type: 'decode', input: '[C]', expected: 'C', desc: 'Methane' },
                { type: 'decode', input: '[C][C]', expected: 'CC', desc: 'Ethane' },
                { type: 'decode', input: '[C][C][O]', expected: 'CCO', desc: 'Ethanol' },
                { type: 'decode', input: '[C][=C]', expected: 'C=C', desc: 'Ethene' },
                { type: 'decode', input: '[C][#N]', expected: 'C#N', desc: 'Acetonitrile' },

                // Basic encoding
                { type: 'encode', input: 'C', expected: '[C]', desc: 'Methane' },
                { type: 'encode', input: 'CC', expected: '[C][C]', desc: 'Ethane' },
                { type: 'encode', input: 'CCO', expected: '[C][C][O]', desc: 'Ethanol' },
                { type: 'encode', input: 'C=C', expected: '[C][=C]', desc: 'Ethene' },
                { type: 'encode', input: 'C#N', expected: '[C][#N]', desc: 'Acetonitrile' },

                // Branches
                { type: 'encode', input: 'CC(C)C', expected: '[C][C][Branch1][C][C][C]', desc: 'Isobutane' },
                { type: 'decode', input: '[C][C][Branch1][C][C][C]', expected: 'CC(C)C', desc: 'Isobutane decode' },

                // Rings
                { type: 'encode', input: 'C1CC1', expected: '[C][C][C][Ring1][C]', desc: 'Cyclopropane' },

                // Aromatics
                { type: 'encode', input: 'c1ccccc1', expected: '[C][=C][C][=C][C][=C][Ring1][=Branch1]', desc: 'Benzene' },

                // Validation
                { type: 'validate', input: '[C][C][O]', expected: true, desc: 'Valid SELFIES' },
                { type: 'validate', input: '[X][Y][Z]', expected: false, desc: 'Invalid tokens' },

                // Properties
                { type: 'weight', input: '[C][C][O]', expected: 46.07, desc: 'Ethanol MW', tolerance: 0.01 },
                { type: 'formula', input: '[C][C][O]', expected: 'C2H6O', desc: 'Ethanol formula' },
            ];

            let passed = 0;
            let failed = 0;
            let html = '<div class="output-section"><h3>Test Results</h3><div class="test-results">';

            for (const test of tests) {
                try {
                    let result;
                    let success = false;

                    switch (test.type) {
                        case 'decode':
                            result = SELFIES.decode(test.input);
                            success = result === test.expected;
                            break;
                        case 'encode':
                            result = SELFIES.encode(test.input);
                            success = result === test.expected;
                            break;
                        case 'validate':
                            result = SELFIES.isValid(test.input);
                            success = result === test.expected;
                            break;
                        case 'weight':
                            result = SELFIES.getMolecularWeight(test.input);
                            success = Math.abs(result - test.expected) < (test.tolerance || 0.01);
                            break;
                        case 'formula':
                            result = SELFIES.getFormula(test.input);
                            success = result === test.expected;
                            break;
                    }

                    if (success) {
                        passed++;
                        html += `<div class="test-item pass">✓ ${test.desc}</div>`;
                    } else {
                        failed++;
                        html += `<div class="test-item fail">✗ ${test.desc}: expected ${test.expected}, got ${result}</div>`;
                    }
                } catch (error) {
                    failed++;
                    html += `<div class="test-item fail">✗ ${test.desc}: ${error.message}</div>`;
                }
            }

            html += `</div>`;
            html += `
                <div class="output-row" style="margin-top: 1rem;">
                    <span class="output-label">Total Tests:</span>
                    <span class="output-value">${tests.length}</span>
                </div>
                <div class="output-row">
                    <span class="output-label">Passed:</span>
                    <span class="output-value" style="color: #4ec9b0;">${passed}</span>
                </div>
                <div class="output-row">
                    <span class="output-label">Failed:</span>
                    <span class="output-value" style="color: ${failed > 0 ? '#f48771' : '#4ec9b0'};">${failed}</span>
                </div>
            </div>`;

            output.innerHTML = html;
            status.textContent = failed === 0 ? 'All tests passed!' : `${failed} test(s) failed`;
            status.className = `status ${failed === 0 ? 'success' : 'error'}`;
        }

        // Load example
        function loadExample() {
            editor.setValue(`# SELFIES Examples
[C][C][O]
[C][=C]
[C][#N]
[C][C][Branch1][C][C][C]

# SMILES Examples
CCO
c1ccccc1
CC(C)C
C=C`);
            processInput();
        }

        // Event listeners
        editor.on('change', debounce(processInput, 500));
        document.getElementById('runBtn').addEventListener('click', runTests);
        document.getElementById('clearBtn').addEventListener('click', () => {
            editor.setValue('');
            output.innerHTML = `
                <div class="output-section">
                    <h3>Welcome</h3>
                    <p>Type a SELFIES string in the editor (e.g., <code>[C][C][O]</code>) to see it decoded to SMILES.</p>
                    <p style="margin-top: 0.5rem;">Or try encoding SMILES to SELFIES!</p>
                    <p style="margin-top: 0.5rem; color: #4ec9b0;">New: View 2D molecular structures with RDKit!</p>
                </div>
            `;
            status.textContent = 'Ready';
            status.className = 'status';
        });
        document.getElementById('exampleBtn').addEventListener('click', loadExample);

        // Initial processing will be done after RDKit loads (see initRDKitModule callback)

        // Check if SELFIES loaded correctly
        if (typeof SELFIES === 'undefined') {
            output.innerHTML = `
                <div class="output-section error">
                    <h3>Error</h3>
                    <p>Failed to load SELFIES-JS library from GitHub releases.</p>
                    <p>Please check that the bundle is available at: <a href="https://github.com/Ghost---Shadow/selfies-js/releases/latest/download/selfies.umd.min.js" target="_blank">GitHub Releases</a></p>
                </div>
            `;
        }
    </script>
</body>
</html>
